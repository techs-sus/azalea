local a,b=table.freeze({0,10,13,34,92}),bit32 local c,d,e=b.lshift,b.rshift,b.band local f=function(f)local g,h,i=0,0,0 for j,k in utf8.codes(f)do if k>127 then local l=e(d(k,8),7)i+=if l~=0b111 then 1 else 0 end i+=1 while i~=0 do h+=7 if h>=8 then g+=1 h-=8 end i-=1 end end local j=buffer.create(g)g,h,i=0,0,0 local k=function(k)k=c(k,1)i=b.bor(i,d(k,h))h+=7 if h>=8 then buffer.writeu8(j,g,i)g+=1 h-=8 i=e(c(k,(7-h)),255)end end for l,m in utf8.codes(f)do if m>127 then local n=e(d(m,8),7)if n~=7 then k(a[n+1])end k(e(m,127))else k(m)end end return j end
